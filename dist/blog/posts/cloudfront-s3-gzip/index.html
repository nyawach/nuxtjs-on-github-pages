<!doctype html>
<html data-n-head-ssr lang="ja" data-n-head="lang">
  <head>
    <title data-n-head="true">CloudFront+S3の静的サイト構成でgzip圧縮データが配信されなかったときに試したこと | hyme</title><meta data-n-head="true" name="fragment" content="!"><meta data-n-head="true" data-hid="charset" charset="utf-8"><meta data-n-head="true" data-hid="viewport" name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta data-n-head="true" data-hid="mobile-web-app-capable" name="mobile-web-app-capable" content="yes"><meta data-n-head="true" data-hid="apple-mobile-web-app-title" name="apple-mobile-web-app-title" content="hyme"><meta data-n-head="true" data-hid="author" name="author" content="hyme"><meta data-n-head="true" data-hid="theme-color" name="theme-color" content="#111"><meta data-n-head="true" data-hid="og:type" name="og:type" property="og:type" content="website"><meta data-n-head="true" data-hid="og:site_name" name="og:site_name" property="og:site_name" content="hyme"><meta data-n-head="true" data-hid="twitter:card" name="twitter:card" property="twitter:card" content="summary_large_image"><meta data-n-head="true" data-hid="twitter:site" name="twitter:site" property="twitter:site" content="@_hyme_"><meta data-n-head="true" data-hid="description" name="description" content="AWSでCloudFront+S3の静的サイトの配信をやることはかなり主流になってきていると思います。この構成で、gzip圧縮をやる際に少し手こずったため、記録しておきます。"><meta data-n-head="true" property="og:title" content="CloudFront+S3の静的サイト構成でgzip圧縮データが配信されなかったときに試したこと" data-hid="og:title"><meta data-n-head="true" property="og:url" content="null" data-hid="og:image"><meta data-n-head="true" property="og:description" content="AWSでCloudFront+S3の静的サイトの配信をやることはかなり主流になってきていると思います。この構成で、gzip圧縮をやる際に少し手こずったため、記録しておきます。" data-hid="og:description"><meta data-n-head="true" property="twitter:title" content="CloudFront+S3の静的サイト構成でgzip圧縮データが配信されなかったときに試したこと" data-hid="twitter:title"><meta data-n-head="true" property="twitter:image" content="null" data-hid="twitter:image"><meta data-n-head="true" property="twitter:description" content="AWSでCloudFront+S3の静的サイトの配信をやることはかなり主流になってきていると思います。この構成で、gzip圧縮をやる際に少し手こずったため、記録しておきます。" data-hid="twitter:description"><link data-n-head="true" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="true" rel="icon" type="image/png" sizes="192x192" href="/icon192.png"><link data-n-head="true" rel="apple-touch-icon" sizes="180x180" href="/icon192.png"><link data-n-head="true" rel="manifest" href="/_nuxt/manifest.349e3904.json"><link data-n-head="true" rel="shortcut icon" href="icon180.png"><script data-n-head="true" src="//www.googletagmanager.com/gtm.js?id=GTM-N72GKLM&l=dataLayer" async></script><link rel="preload" href="/_nuxt/88cac443fc3cc736be10.js" as="script"><link rel="preload" href="/_nuxt/3f4eac2dce17f6d01105.js" as="script"><link rel="preload" href="/_nuxt/be114672403339f61f60.css" as="style"><link rel="preload" href="/_nuxt/effa0df5afd9d6dc4424.js" as="script"><link rel="preload" href="/_nuxt/4f4fb2519cc40ad9f2e0.css" as="style"><link rel="preload" href="/_nuxt/f4f02ede605167a5d334.js" as="script"><link rel="preload" href="/_nuxt/ca2abb884837f33d058f.css" as="style"><link rel="preload" href="/_nuxt/e2933058242d1d7a0ae8.js" as="script"><link rel="preload" href="/_nuxt/4e157051666d0935c86b.css" as="style"><link rel="preload" href="/_nuxt/9598c174a80a278ebe77.js" as="script"><link rel="preload" href="/_nuxt/d83fbff8b371de5e12da.css" as="style"><link rel="preload" href="/_nuxt/064120721cb016345a4d.js" as="script"><link rel="preload" href="/_nuxt/f7125c16520a272d86f8.css" as="style"><link rel="preload" href="/_nuxt/e57654431899a8469e5c.js" as="script"><link rel="stylesheet" href="/_nuxt/be114672403339f61f60.css"><link rel="stylesheet" href="/_nuxt/4f4fb2519cc40ad9f2e0.css"><link rel="stylesheet" href="/_nuxt/ca2abb884837f33d058f.css"><link rel="stylesheet" href="/_nuxt/4e157051666d0935c86b.css"><link rel="stylesheet" href="/_nuxt/d83fbff8b371de5e12da.css"><link rel="stylesheet" href="/_nuxt/f7125c16520a272d86f8.css">
    <script>window.prerenderReady=!1</script>
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><main class="blog-slug" data-v-2ebd83c9><header data-v-75930c71 data-v-2ebd83c9><div class="logo" data-v-75930c71><a href="/" class="logo__link nuxt-link-active" data-v-75930c71>hyme</a></div><div class="lead" data-v-75930c71>ちょっとなにかある。</div></header><!----><article data-v-2ebd83c9 data-v-2ebd83c9><div class="info" data-v-19c7fa40 data-v-2ebd83c9><a href="/blog/categories/web" class="category" data-v-19c7fa40>Web</a><div class="tags" data-v-19c7fa40><a href="/blog/tags/aws" class="tag" data-v-19c7fa40>AWS</a></div><time class="updated-at" data-v-19c7fa40>2019.02.15</time></div><h1 data-v-2ebd83c9>CloudFront+S3の静的サイト構成でgzip圧縮データが配信されなかったときに試したこと</h1><div class="toc" data-v-2ebd83c9><div class="toc__title" data-v-2ebd83c9><span data-v-2ebd83c9>INDEX</span></div><ul class="toc__list" data-v-2ebd83c9></ul></div><div class="content" data-v-2ebd83c9><p>AWSでCloudFront+S3の静的サイトの配信をやることはかなり主流になってきていると思います。<br>この構成で、gzip圧縮をやる際に少し手こずったため、記録しておきます。</p>
<h2 id="index_1-0-0">サイト構成について</h2><p>シンプルなS3+CloudFrontの構成です。</p>
<p>S3に関しては、ウェブサイトホスティングの設定を有効にしていました。<br>CloudFrontでは、S3のウェブサイトホスティングのURLをoriginに指定しておく構成です。</p>
<h2 id="index_2-0-0">気づき</h2><p>CloudFrontのBehaviorの設定には、「Compress Objects Automatically」という項目があります。</p>
<blockquote>
<p>Select whether you want CloudFront to automatically compress content for web requests that include Accept-Encoding: gzip in the request header. CloudFront compresses files of certain types for both Amazon S3 and custom origins.</p>
<p>「Compress Objects Automatically」のinformationより</p>
</blockquote>
<p>要約すると、「Accept-Encoding: gzipのヘッダがリクエストに含まれてたら、作れるやつは自動でgzipデータに圧縮するよ」というものです。<br>これをチェックすれば、自動的にgzip配信が適用されると思い「Yes」にしていました。</p>
<p><img class="lazyestload" src="/img/placeholder.svg" data-src="//images.ctfassets.net/xisblufoxlb6/65d91j7YtjfJqv6UXr6E7h/3e2a5bbd200de49f08cfeb97e48e7896/image01.jpg" alt="image01"></p>
<p>ですが、CloudFrontで配信されているページで確認してみると、非圧縮のままのデータが送信されていました。</p>
<p><img class="lazyestload" src="/img/placeholder.svg" data-src="//images.ctfassets.net/xisblufoxlb6/7B8HjbIjrjNzroMSDuRzrn/47e286e90b485631cd23f7198fbf97ab/image00.jpg" alt="image00"></p>
<p>「gzip圧縮データが配信されていない…」</p>
<h2 id="index_3-0-0">解決方法</h2><p>CloudFrontのBehaviorの設定項目の「Whitelist Headers」に、「Accept-Encoding」を追加することで、gzip配信が可能になりました。</p>
<p><img class="lazyestload" src="/img/placeholder.svg" data-src="//images.ctfassets.net/xisblufoxlb6/2Dof12zemTbqgUsuT0sqbc/3bd0a26da7d74a16eb6b85d841e25be9/image02.jpg" alt="image02"></p>
<p>実際にChromeのDevToolsで確認してみましょう。</p>
<p><img class="lazyestload" src="/img/placeholder.svg" data-src="//images.ctfassets.net/xisblufoxlb6/6hc9NVpbI2qxVHMPrmnCU0/05f9381563e8f1fc4c134c6dcb78e705/image03.jpg" alt="image03"></p>
<p>無事gzipが返されていることが確認できました！</p>
<h2 id="index_4-0-0">参考文献</h2><ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/ServingCompressedFiles.html" target="_blank" title="null" rel="noreferrer">圧縮ファイルの供給 - Amazon CloudFront</a></li>
</ul>
</div><div class="back" data-v-2ebd83c9><a href="/blog/" class="back__link nuxt-link-active" data-v-2ebd83c9>BLOG</a></div></article><footer class="footer" data-v-6241211e data-v-2ebd83c9><div class="inner" data-v-6241211e><small class="copy" data-v-6241211e>© 2018-2019 hyme</small></div></footer></main></div></div><script>window.__NUXT__=function(e,n,t,s,o,i,a,d,l,r,p){return r.sys={space:{sys:{type:e,linkType:i,id:t}},id:"1RHECfKcNO0OaW280uCOCY",type:s,createdAt:"2018-06-09T13:05:20.243Z",updatedAt:"2018-06-09T13:05:58.402Z",environment:{sys:{id:o,type:e,linkType:n}},revision:2,contentType:{sys:{type:e,linkType:d,id:"category"}},locale:a},r.fields={name:"Web",slug:"web"},{layout:"default",data:[{post:{sys:{space:{sys:{type:e,linkType:i,id:t}},id:"Lb0MCBO8CBAuKeQd5aIT1",type:s,createdAt:"2019-02-15T14:35:04.522Z",updatedAt:"2019-02-15T14:47:26.610Z",environment:{sys:{id:o,type:e,linkType:n}},revision:2,contentType:{sys:{type:e,linkType:d,id:"blog"}},locale:a},fields:{title:"CloudFront+S3の静的サイト構成でgzip圧縮データが配信されなかったときに試したこと",slug:"cloudfront-s3-gzip",category:r,tag:[{sys:{space:{sys:{type:e,linkType:i,id:t}},id:"7JxwCr68jvbBm66u0Ded8h",type:s,createdAt:p,updatedAt:p,environment:{sys:{id:o,type:e,linkType:n}},revision:1,contentType:{sys:{type:e,linkType:d,id:"tag"}},locale:a},fields:{name:"AWS",slug:"aws",category:r}}],description:"AWSでCloudFront+S3の静的サイトの配信をやることはかなり主流になってきていると思います。この構成で、gzip圧縮をやる際に少し手こずったため、記録しておきます。",body:"AWSでCloudFront+S3の静的サイトの配信をやることはかなり主流になってきていると思います。  \nこの構成で、gzip圧縮をやる際に少し手こずったため、記録しておきます。\n\n## サイト構成について\n\nシンプルなS3+CloudFrontの構成です。\n\nS3に関しては、ウェブサイトホスティングの設定を有効にしていました。  \nCloudFrontでは、S3のウェブサイトホスティングのURLをoriginに指定しておく構成です。\n\n## 気づき\n\nCloudFrontのBehaviorの設定には、「Compress Objects Automatically」という項目があります。\n\n> Select whether you want CloudFront to automatically compress content for web requests that include Accept-Encoding: gzip in the request header. CloudFront compresses files of certain types for both Amazon S3 and custom origins.\n>\n> 「Compress Objects Automatically」のinformationより\n\n要約すると、「Accept-Encoding: gzipのヘッダがリクエストに含まれてたら、作れるやつは自動でgzipデータに圧縮するよ」というものです。  \nこれをチェックすれば、自動的にgzip配信が適用されると思い「Yes」にしていました。\n\n![image01](//images.ctfassets.net/xisblufoxlb6/65d91j7YtjfJqv6UXr6E7h/3e2a5bbd200de49f08cfeb97e48e7896/image01.jpg)\n\nですが、CloudFrontで配信されているページで確認してみると、非圧縮のままのデータが送信されていました。\n\n![image00](//images.ctfassets.net/xisblufoxlb6/7B8HjbIjrjNzroMSDuRzrn/47e286e90b485631cd23f7198fbf97ab/image00.jpg)\n\n「gzip圧縮データが配信されていない…」\n\n## 解決方法\n\nCloudFrontのBehaviorの設定項目の「Whitelist Headers」に、「Accept-Encoding」を追加することで、gzip配信が可能になりました。\n\n![image02](//images.ctfassets.net/xisblufoxlb6/2Dof12zemTbqgUsuT0sqbc/3bd0a26da7d74a16eb6b85d841e25be9/image02.jpg)\n\n実際にChromeのDevToolsで確認してみましょう。\n\n![image03](//images.ctfassets.net/xisblufoxlb6/6hc9NVpbI2qxVHMPrmnCU0/05f9381563e8f1fc4c134c6dcb78e705/image03.jpg)\n\n無事gzipが返されていることが確認できました！\n\n## 参考文献\n\n- [圧縮ファイルの供給 - Amazon CloudFront](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/ServingCompressedFiles.html)"}}}],error:null,state:{auth:!1},serverRendered:!0}}("Link","Environment","xisblufoxlb6","Entry","master","Space","ja-JP","ContentType",0,{},"2019-02-15T14:15:52.388Z")</script><script src="/_nuxt/88cac443fc3cc736be10.js" defer></script><script src="/_nuxt/f4f02ede605167a5d334.js" defer></script><script src="/_nuxt/e2933058242d1d7a0ae8.js" defer></script><script src="/_nuxt/9598c174a80a278ebe77.js" defer></script><script src="/_nuxt/064120721cb016345a4d.js" defer></script><script src="/_nuxt/e57654431899a8469e5c.js" defer></script><script src="/_nuxt/3f4eac2dce17f6d01105.js" defer></script><script src="/_nuxt/effa0df5afd9d6dc4424.js" defer></script>
  </body>
</html>
